spring:
  application:
    name: albunyaan-tube
  # BACKEND-PERF-01: Cache configuration
  # Using Caffeine (in-memory) for dev, can switch to Redis for prod
  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=1000,expireAfterWrite=3600s
    cache-names:
      - newpipeChannelInfo
      - newpipePlaylistInfo
      - newpipeVideoInfo
      - newpipeStreamUrls
      - newpipeSearchResults
      - newpipeChannelValidation
      - newpipePlaylistValidation
      - newpipeVideoValidation
      - categoryNameMapping
#    # Uncomment below for Redis in production
#    type: redis
#    redis:
#      time-to-live: 3600000 # 1 hour default TTL in milliseconds
#  data:
#    redis:
#      host: ${REDIS_HOST:localhost}
#      port: ${REDIS_PORT:6379}
#      password: ${REDIS_PASSWORD:}
#      lettuce:
#        pool:
#          max-active: 10
#          max-idle: 5
#          min-idle: 1
  # Gzip compression for responses
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain
    min-response-size: 1024
  # Task scheduling configuration
  task:
    scheduling:
      pool:
        size: 3 # Thread pool size for scheduled tasks
      thread-name-prefix: scheduled-task-
server:
  port: 8080
  compression:
    enabled: true
management:
  endpoints:
    web:
      exposure:
        # Limit exposed endpoints for security (httptrace removed - obsolete in Boot 3)
        # All endpoints now require ADMIN role (see SecurityConfig)
        include: health,info,metrics,prometheus,caches
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
      show-components: when-authorized
    metrics:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5, 0.95, 0.99
      sla:
        http.server.requests: 200ms, 500ms, 1s, 2s
    tags:
      application: ${spring.application.name}
      environment: ${ENVIRONMENT:dev}
    enable:
      jvm: true
      process: true
      system: true
      tomcat: true
      cache: true
app:
  # Video validation scheduler settings (YouTube rate limit prevention)
  validation:
    video:
      scheduler:
        # Enable/disable scheduled validation (can be changed without code deploy)
        enabled: ${APP_VALIDATION_SCHEDULER_ENABLED:true}
        # Cron expression for validation schedule (UTC timezone)
        # Default: once daily at 6:00 AM UTC
        cron: ${APP_VALIDATION_SCHEDULER_CRON:0 0 6 * * ?}
        # Distributed lock TTL in minutes (prevents concurrent runs)
        lock-ttl-minutes: ${APP_VALIDATION_LOCK_TTL_MINUTES:120}
        # Maximum items to validate per run (lower = safer)
        max-items-per-run: ${APP_VALIDATION_MAX_ITEMS:10}
  # YouTube request throttling and circuit breaker (prevents anti-bot detection)
  youtube:
    throttle:
      # Enable/disable request throttling
      enabled: ${APP_YOUTUBE_THROTTLE_ENABLED:true}
      # Base delay between YouTube API calls (milliseconds)
      delay-between-items-ms: ${APP_YOUTUBE_THROTTLE_DELAY_MS:3000}
      # Random jitter added to delay to avoid patterns (milliseconds)
      jitter-ms: ${APP_YOUTUBE_THROTTLE_JITTER_MS:1000}
    circuit-breaker:
      # Enable/disable circuit breaker for YouTube rate limiting protection
      enabled: ${APP_YOUTUBE_CIRCUIT_BREAKER_ENABLED:true}
      # Firestore persistence settings
      persistence-collection: ${APP_YOUTUBE_CB_COLLECTION:system_settings}
      persistence-document-id: ${APP_YOUTUBE_CB_DOC_ID:youtube_circuit_breaker}
      # Cooldown duration at backoff level 0 (minutes) - default 1 hour
      cooldown-base-minutes: ${APP_YOUTUBE_CB_COOLDOWN_BASE:60}
      # Maximum cooldown duration (minutes) - default 48 hours
      cooldown-max-minutes: ${APP_YOUTUBE_CB_COOLDOWN_MAX:2880}
      # Hours of successful operation before decrementing backoff level
      backoff-decay-hours: ${APP_YOUTUBE_CB_BACKOFF_DECAY_HOURS:48}
      # Timeout for HALF_OPEN probe requests (seconds)
      probe-timeout-seconds: ${APP_YOUTUBE_CB_PROBE_TIMEOUT:30}
      # Rolling window: number of rate-limit errors to trigger breaker open
      rolling-window-error-threshold: ${APP_YOUTUBE_CB_ERROR_THRESHOLD:3}
      # Rolling window: time window for counting errors (minutes)
      rolling-window-minutes: ${APP_YOUTUBE_CB_WINDOW_MINUTES:10}
      # Maximum retry attempts for persisting circuit breaker state
      max-persistence-retries: ${APP_YOUTUBE_CB_MAX_RETRIES:3}
  firebase:
    # Path to Firebase service account JSON (set via environment variable in production)
    service-account-path: ${FIREBASE_SERVICE_ACCOUNT_PATH:classpath:firebase-service-account.json}
    project-id: ${FIREBASE_PROJECT_ID:albunyaan-tube}
    # Firestore settings
    firestore:
      database-id: ${FIRESTORE_DATABASE_ID:(default)}
      # Operation-specific timeouts (in seconds)
      timeout:
        read: ${FIRESTORE_READ_TIMEOUT:5}           # Single document reads
        write: ${FIRESTORE_WRITE_TIMEOUT:10}        # Document writes/updates
        bulk-query: ${FIRESTORE_BULK_QUERY_TIMEOUT:30}  # Collection queries, findAll, search
      # Default maximum results for unbounded queries
      default-max-results: ${FIRESTORE_DEFAULT_MAX_RESULTS:1000}
  newpipe:
    # NewPipeExtractor configuration (no API key required)
    # Cache TTL for stream URLs (30 minutes, similar to Android implementation)
    stream-cache-ttl-minutes: 30
    # Executor service settings
    executor:
      # Thread pool size for batch operations (1 = sequential, safer for rate limiting)
      pool-size: ${APP_NEWPIPE_EXECUTOR_POOL_SIZE:1}
    # HTTP client settings
    http:
      connect-timeout-seconds: 30
      read-timeout-seconds: 30
      # User agent for NewPipe requests
      user-agent: "Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0"
      # Body logging for debugging (disabled by default to avoid leaking data in prod)
      # Set to true via env var for debugging: APP_NEWPIPE_HTTP_LOG_BODY_ENABLED=true
      log-body-enabled: ${APP_NEWPIPE_HTTP_LOG_BODY_ENABLED:false}
      log-body-chars: 400
  security:
    cors:
      allowed-origins: "http://localhost:5173,http://127.0.0.1:5173"
    initial-admin:
      email: admin@albunyaan.tube
      password: ChangeMe!123
      display-name: Initial Admin
download:
  token:
    # SECURITY: Secret key for generating download tokens
    # Set via environment variable in production: DOWNLOAD_TOKEN_SECRET_KEY
    # NEVER commit production secrets to version control
    secret-key: ${DOWNLOAD_TOKEN_SECRET_KEY:albunyaan-download-secret-key-change-in-production}


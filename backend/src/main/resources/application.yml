spring:
  application:
    name: albunyaan-tube
  # BACKEND-PERF-01: Cache configuration
  # Using Caffeine (in-memory) for dev, can switch to Redis for prod
  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=1000,expireAfterWrite=3600s
    cache-names:
      - newpipeChannelInfo
      - newpipePlaylistInfo
      - newpipeVideoInfo
      - newpipeStreamUrls
      - newpipeSearchResults
      - newpipeChannelValidation
      - newpipePlaylistValidation
      - newpipeVideoValidation
      - categoryNameMapping
#    # Uncomment below for Redis in production
#    type: redis
#    redis:
#      time-to-live: 3600000 # 1 hour default TTL in milliseconds
#  data:
#    redis:
#      host: ${REDIS_HOST:localhost}
#      port: ${REDIS_PORT:6379}
#      password: ${REDIS_PASSWORD:}
#      lettuce:
#        pool:
#          max-active: 10
#          max-idle: 5
#          min-idle: 1
  # Gzip compression for responses
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain
    min-response-size: 1024
  # Task scheduling configuration
  task:
    scheduling:
      pool:
        size: 3 # Thread pool size for scheduled tasks
      thread-name-prefix: scheduled-task-
server:
  port: 8080
  compression:
    enabled: true
management:
  endpoints:
    web:
      exposure:
        # Limit exposed endpoints for security (httptrace removed - obsolete in Boot 3)
        # All endpoints now require ADMIN role (see SecurityConfig)
        include: health,info,metrics,prometheus,caches
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
      show-components: when-authorized
    metrics:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5, 0.95, 0.99
      sla:
        http.server.requests: 200ms, 500ms, 1s, 2s
    tags:
      application: ${spring.application.name}
      environment: ${ENVIRONMENT:dev}
    enable:
      jvm: true
      process: true
      system: true
      tomcat: true
      cache: true
app:
  firebase:
    # Path to Firebase service account JSON (set via environment variable in production)
    service-account-path: ${FIREBASE_SERVICE_ACCOUNT_PATH:classpath:firebase-service-account.json}
    project-id: ${FIREBASE_PROJECT_ID:albunyaan-tube}
    # Firestore settings
    firestore:
      database-id: ${FIRESTORE_DATABASE_ID:(default)}
      # Operation-specific timeouts (in seconds)
      timeout:
        read: ${FIRESTORE_READ_TIMEOUT:5}           # Single document reads
        write: ${FIRESTORE_WRITE_TIMEOUT:10}        # Document writes/updates
        bulk-query: ${FIRESTORE_BULK_QUERY_TIMEOUT:30}  # Collection queries, findAll, search
      # Default maximum results for unbounded queries
      default-max-results: ${FIRESTORE_DEFAULT_MAX_RESULTS:1000}
  newpipe:
    # NewPipeExtractor configuration (no API key required)
    # Cache TTL for stream URLs (30 minutes, similar to Android implementation)
    stream-cache-ttl-minutes: 30
    # Executor service settings
    executor:
      pool-size: 1  # REDUCED from 3 to 1 to minimize concurrent requests
    # HTTP client settings
    http:
      connect-timeout-seconds: 30
      read-timeout-seconds: 30
      # User agent for NewPipe requests
      user-agent: "Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0"
      # Body logging for debugging (disabled by default to avoid leaking data in prod)
      # Set to true via env var for debugging: APP_NEWPIPE_HTTP_LOG_BODY_ENABLED=true
      log-body-enabled: ${APP_NEWPIPE_HTTP_LOG_BODY_ENABLED:false}
      log-body-chars: 400
  # Content validation settings (for scheduled video/channel/playlist checks)
  validation:
    video:
      # Maximum items to validate per scheduled run (conservative default to prevent rate limiting)
      max-items-per-run: ${APP_VALIDATION_VIDEO_MAX_ITEMS_PER_RUN:10}
      scheduler:
        # Enable/disable scheduled validation (set to false to stop all scheduled runs)
        enabled: ${APP_VALIDATION_VIDEO_SCHEDULER_ENABLED:true}
        # Cron expression for validation schedule (default: once daily at 6 AM UTC)
        # Format: second minute hour day-of-month month day-of-week
        cron: ${APP_VALIDATION_VIDEO_SCHEDULER_CRON:0 0 6 * * ?}
        # Distributed lock TTL in minutes (default: 2 hours)
        # Should be longer than maximum expected validation run duration
        lock-ttl-minutes: ${APP_VALIDATION_VIDEO_SCHEDULER_LOCK_TTL_MINUTES:120}
    youtube:
      throttle:
        # Enable throttling between YouTube requests
        enabled: ${APP_VALIDATION_YOUTUBE_THROTTLE_ENABLED:true}
        # Delay between requests in milliseconds (default: 3 seconds)
        delay-between-items-ms: ${APP_VALIDATION_YOUTUBE_THROTTLE_DELAY_MS:3000}
        # Random jitter added to delay (up to this value in ms, default: 1 second)
        jitter-ms: ${APP_VALIDATION_YOUTUBE_THROTTLE_JITTER_MS:1000}
      circuit-breaker:
        # Enable circuit breaker for rate limiting protection
        enabled: ${APP_VALIDATION_YOUTUBE_CIRCUIT_BREAKER_ENABLED:true}
        # Base cooldown period (Level 0) in minutes (default: 1 hour)
        cooldown-base-minutes: ${APP_VALIDATION_YOUTUBE_CIRCUIT_BREAKER_COOLDOWN_BASE_MINUTES:60}
        # Maximum cooldown (Level 4 cap) in minutes (default: 48 hours)
        cooldown-max-minutes: ${APP_VALIDATION_YOUTUBE_CIRCUIT_BREAKER_COOLDOWN_MAX_MINUTES:2880}
        # Hours of success before decrementing backoff level (default: 48 hours)
        backoff-decay-hours: ${APP_VALIDATION_YOUTUBE_CIRCUIT_BREAKER_BACKOFF_DECAY_HOURS:48}
        # Timeout for HALF_OPEN probe requests in seconds (default: 30s)
        probe-timeout-seconds: ${APP_VALIDATION_YOUTUBE_CIRCUIT_BREAKER_PROBE_TIMEOUT_SECONDS:30}
        # Rolling window policy: open breaker after N errors within T minutes
        rolling-window:
          # Number of rate-limit errors to trigger circuit open (default: 3)
          error-threshold: ${APP_VALIDATION_YOUTUBE_CIRCUIT_BREAKER_ERROR_THRESHOLD:3}
          # Time window in minutes to count errors within (default: 10 minutes)
          window-minutes: ${APP_VALIDATION_YOUTUBE_CIRCUIT_BREAKER_WINDOW_MINUTES:10}
  security:
    cors:
      # Override in production via env var: APP_SECURITY_CORS_ALLOWED_ORIGINS
      allowed-origins: ${APP_SECURITY_CORS_ALLOWED_ORIGINS:http://localhost:5173,http://127.0.0.1:5173}
    initial-admin:
      email: admin@albunyaan.tube
      password: ChangeMe!123
      display-name: Initial Admin
download:
  token:
    # SECURITY: Secret key for generating download tokens
    # Set via environment variable in production: DOWNLOAD_TOKEN_SECRET_KEY
    # NEVER commit production secrets to version control
    secret-key: ${DOWNLOAD_TOKEN_SECRET_KEY:albunyaan-download-secret-key-change-in-production}

